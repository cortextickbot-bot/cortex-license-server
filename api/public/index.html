<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cortex License Manager</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Outfit:wght@300;400;600;700&display=swap');
  
  * { margin: 0; padding: 0; box-sizing: border-box; }
  
  :root {
    --bg: #0a0a0f;
    --card: #12121a;
    --border: #1e1e2e;
    --text: #e0e0e8;
    --dim: #6b6b80;
    --accent: #00d4aa;
    --accent2: #00b894;
    --red: #ff4757;
    --orange: #ffa502;
    --blue: #3742fa;
    --green: #2ed573;
  }
  
  body {
    font-family: 'Outfit', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
  }
  
  #loginScreen {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    background: radial-gradient(ellipse at 50% 0%, #0d1f1a 0%, var(--bg) 60%);
  }
  
  .login-box {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 48px 40px;
    width: 380px;
    text-align: center;
  }
  
  .login-box h1 {
    font-family: 'JetBrains Mono', monospace;
    font-size: 20px;
    color: var(--accent);
    margin-bottom: 8px;
    letter-spacing: 2px;
  }
  
  .login-box p { color: var(--dim); font-size: 13px; margin-bottom: 32px; }
  
  .login-box input {
    width: 100%;
    padding: 14px 18px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 10px;
    color: var(--text);
    font-family: 'JetBrains Mono', monospace;
    font-size: 14px;
    outline: none;
    margin-bottom: 16px;
    transition: border 0.2s;
  }
  
  .login-box input:focus { border-color: var(--accent); }
  
  .login-box button {
    width: 100%;
    padding: 14px;
    background: var(--accent);
    color: #000;
    border: none;
    border-radius: 10px;
    font-family: 'Outfit', sans-serif;
    font-weight: 700;
    font-size: 15px;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .login-box button:hover { background: var(--accent2); transform: translateY(-1px); }
  .login-error { color: var(--red); font-size: 13px; margin-top: 12px; display: none; }
  
  #dashboard { display: none; }
  
  .topbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px 32px;
    border-bottom: 1px solid var(--border);
    background: var(--card);
  }
  
  .topbar h1 {
    font-family: 'JetBrains Mono', monospace;
    font-size: 16px;
    color: var(--accent);
    letter-spacing: 1.5px;
  }
  
  .topbar .logout {
    background: none;
    border: 1px solid var(--border);
    color: var(--dim);
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 13px;
    font-family: 'Outfit', sans-serif;
    transition: all 0.2s;
  }
  
  .topbar .logout:hover { border-color: var(--red); color: var(--red); }
  .content { max-width: 1000px; margin: 0 auto; padding: 32px 24px; }
  
  .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 32px; }
  
  .stat-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
  }
  
  .stat-card .label { color: var(--dim); font-size: 12px; text-transform: uppercase; letter-spacing: 1px; }
  .stat-card .value { font-size: 28px; font-weight: 700; margin-top: 6px; font-family: 'JetBrains Mono', monospace; }
  .stat-card .value.green { color: var(--green); }
  .stat-card .value.orange { color: var(--orange); }
  .stat-card .value.red { color: var(--red); }
  .stat-card .value.blue { color: var(--accent); }
  
  .generate-section {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 32px;
  }
  
  .generate-section h2 { font-size: 15px; font-weight: 600; margin-bottom: 20px; color: var(--accent); }
  .gen-row { display: flex; gap: 12px; align-items: flex-end; }
  .gen-field { flex: 1; }
  .gen-field label { display: block; font-size: 11px; color: var(--dim); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; }
  
  .gen-field input, .gen-field select {
    width: 100%;
    padding: 12px 14px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px;
    outline: none;
  }
  
  .gen-field input:focus, .gen-field select:focus { border-color: var(--accent); }
  
  .btn-generate {
    padding: 12px 28px;
    background: var(--accent);
    color: #000;
    border: none;
    border-radius: 8px;
    font-weight: 700;
    font-size: 14px;
    cursor: pointer;
    white-space: nowrap;
    font-family: 'Outfit', sans-serif;
    transition: all 0.2s;
  }
  
  .btn-generate:hover { background: var(--accent2); }
  
  .generated-key {
    display: none;
    margin-top: 16px;
    padding: 16px 20px;
    background: #0a1f18;
    border: 1px solid #1a3d30;
    border-radius: 10px;
  }
  
  .generated-key .key-text {
    font-family: 'JetBrains Mono', monospace;
    font-size: 18px;
    color: var(--accent);
    font-weight: 700;
    letter-spacing: 1.5px;
  }
  
  .btn-copy {
    margin-left: 12px;
    padding: 6px 16px;
    background: transparent;
    border: 1px solid var(--accent);
    color: var(--accent);
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    font-family: 'Outfit', sans-serif;
    transition: all 0.2s;
  }
  
  .btn-copy:hover { background: var(--accent); color: #000; }
  
  .keys-section {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
  }
  
  .keys-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px 24px;
    border-bottom: 1px solid var(--border);
  }
  
  .keys-header h2 { font-size: 15px; font-weight: 600; color: var(--text); }
  
  .btn-refresh {
    padding: 8px 16px;
    background: transparent;
    border: 1px solid var(--border);
    color: var(--dim);
    border-radius: 8px;
    cursor: pointer;
    font-size: 13px;
    font-family: 'Outfit', sans-serif;
    transition: all 0.2s;
  }
  
  .btn-refresh:hover { border-color: var(--accent); color: var(--accent); }
  
  table { width: 100%; border-collapse: collapse; }
  th { text-align: left; padding: 12px 16px; font-size: 11px; color: var(--dim); text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid var(--border); background: var(--bg); }
  td { padding: 14px 16px; font-size: 13px; border-bottom: 1px solid #1a1a24; }
  tr:hover td { background: #16161f; }
  
  .key-mono { font-family: 'JetBrains Mono', monospace; font-size: 12px; color: var(--accent); cursor: pointer; }
  .key-mono:hover { text-decoration: underline; }
  
  .badge { padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
  .badge.active { background: #0d2e1f; color: var(--green); }
  .badge.expired { background: #2e1d0d; color: var(--orange); }
  .badge.revoked { background: #2e0d0d; color: var(--red); }
  .badge.unused { background: #0d1a2e; color: #5b9fff; }
  
  .action-btns { display: flex; gap: 6px; }
  .btn-sm { padding: 5px 10px; border-radius: 6px; font-size: 11px; cursor: pointer; border: 1px solid var(--border); background: transparent; color: var(--dim); font-family: 'Outfit', sans-serif; transition: all 0.15s; }
  .btn-sm:hover { border-color: var(--accent); color: var(--accent); }
  .btn-sm.danger:hover { border-color: var(--red); color: var(--red); }
  
  .empty-state { padding: 60px 20px; text-align: center; color: var(--dim); font-size: 14px; }
  
  .toast { position: fixed; bottom: 24px; right: 24px; padding: 14px 24px; background: var(--card); border: 1px solid var(--accent); border-radius: 10px; color: var(--accent); font-size: 14px; font-family: 'Outfit', sans-serif; transform: translateY(100px); opacity: 0; transition: all 0.3s ease; z-index: 999; }
  .toast.show { transform: translateY(0); opacity: 1; }
  .toast.error { border-color: var(--red); color: var(--red); }
  
  .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 100; align-items: center; justify-content: center; }
  .modal-overlay.show { display: flex; }
  .modal { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 32px; width: 400px; max-width: 90vw; }
  .modal h3 { font-size: 16px; margin-bottom: 16px; }
  .modal p { color: var(--dim); font-size: 13px; margin-bottom: 20px; line-height: 1.6; }
  .modal .key-display { font-family: 'JetBrains Mono', monospace; color: var(--accent); }
  .modal-btns { display: flex; gap: 10px; justify-content: flex-end; }
  .modal-btns button { padding: 10px 20px; border-radius: 8px; font-size: 13px; cursor: pointer; font-family: 'Outfit', sans-serif; font-weight: 600; border: 1px solid var(--border); background: transparent; color: var(--text); transition: all 0.15s; }
  .modal-btns .confirm { background: var(--red); color: #fff; border-color: var(--red); }
  .modal-btns .confirm:hover { opacity: 0.85; }
  .modal-btns button:hover { border-color: var(--dim); }
  
  @media (max-width: 768px) {
    .stats { grid-template-columns: repeat(2, 1fr); }
    .gen-row { flex-direction: column; }
    .content { padding: 20px 16px; }
    td, th { padding: 10px 12px; font-size: 12px; }
  }
</style>
</head>
<body>

<div id="loginScreen">
  <div class="login-box">
    <h1>CORTEX LICENSE</h1>
    <p>Admin Panel</p>
    <input type="password" id="passwordInput" placeholder="Enter admin password" onkeydown="if(event.key==='Enter')doLogin()">
    <button onclick="doLogin()">AUTHENTICATE</button>
    <div class="login-error" id="loginError">Invalid password</div>
  </div>
</div>

<div id="dashboard">
  <div class="topbar">
    <h1>CORTEX LICENSE MANAGER</h1>
    <button class="logout" onclick="doLogout()">Logout</button>
  </div>
  <div class="content">
    <div class="stats">
      <div class="stat-card"><div class="label">Total Keys</div><div class="value blue" id="statTotal">0</div></div>
      <div class="stat-card"><div class="label">Active</div><div class="value green" id="statActive">0</div></div>
      <div class="stat-card"><div class="label">Expired</div><div class="value orange" id="statExpired">0</div></div>
      <div class="stat-card"><div class="label">Revoked</div><div class="value red" id="statRevoked">0</div></div>
    </div>
    <div class="generate-section">
      <h2>Generate New License Key</h2>
      <div class="gen-row">
        <div class="gen-field"><label>Validity (Days)</label><select id="genDays"><option value="7">7 Days</option><option value="14">14 Days</option><option value="30" selected>30 Days</option><option value="60">60 Days</option><option value="90">90 Days</option><option value="180">180 Days</option><option value="365">365 Days</option></select></div>
        <div class="gen-field"><label>Client Note (Optional)</label><input type="text" id="genNote" placeholder="e.g. John - Account 12345"></div>
        <button class="btn-generate" onclick="generateKey()">GENERATE KEY</button>
      </div>
      <div class="generated-key" id="generatedKey"><span class="key-text" id="newKeyText"></span><button class="btn-copy" onclick="copyKey()">Copy</button></div>
    </div>
    <div class="keys-section">
      <div class="keys-header"><h2>All License Keys</h2><button class="btn-refresh" onclick="loadKeys()">Refresh</button></div>
      <table><thead><tr><th>License Key</th><th>Account</th><th>Status</th><th>Days Left</th><th>Note</th><th>Actions</th></tr></thead><tbody id="keysBody"><tr><td colspan="6" class="empty-state">Loading keys...</td></tr></tbody></table>
    </div>
  </div>
</div>

<div class="modal-overlay" id="confirmModal">
  <div class="modal">
    <h3 id="modalTitle">Confirm Action</h3>
    <p id="modalMessage"></p>
    <div class="modal-btns"><button onclick="closeModal()">Cancel</button><button class="confirm" id="modalConfirm">Confirm</button></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
let TOKEN = '';

function showToast(msg, isError = false) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = isError ? 'toast error show' : 'toast show';
  setTimeout(() => t.className = 'toast', 3000);
}

async function doLogin() {
  const pw = document.getElementById('passwordInput').value;
  if (!pw) return;
  TOKEN = pw;
  try {
    const res = await fetch('/api/keys', { headers: { 'Authorization': `Bearer ${pw}` } });
    if (res.status === 401) { document.getElementById('loginError').style.display = 'block'; TOKEN = ''; return; }
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('dashboard').style.display = 'block';
    loadKeys();
  } catch (e) { showToast('Connection error', true); }
}

function doLogout() {
  TOKEN = '';
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('dashboard').style.display = 'none';
  document.getElementById('passwordInput').value = '';
  document.getElementById('loginError').style.display = 'none';
}

async function generateKey() {
  const days = document.getElementById('genDays').value;
  const note = document.getElementById('genNote').value;
  try {
    const res = await fetch('/api/generate', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${TOKEN}` }, body: JSON.stringify({ expiry_days: parseInt(days), note }) });
    const data = await res.json();
    if (data.success) { document.getElementById('newKeyText').textContent = data.key; document.getElementById('generatedKey').style.display = 'block'; showToast('Key generated!'); loadKeys(); }
  } catch (e) { showToast('Failed to generate key', true); }
}

function copyKey() { navigator.clipboard.writeText(document.getElementById('newKeyText').textContent); showToast('Key copied!'); }

async function loadKeys() {
  try {
    const res = await fetch('/api/keys', { headers: { 'Authorization': `Bearer ${TOKEN}` } });
    const data = await res.json();
    const tbody = document.getElementById('keysBody');
    if (!data.keys || data.keys.length === 0) { tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No keys yet. Generate your first key above!</td></tr>'; updateStats([]); return; }
    updateStats(data.keys);
    tbody.innerHTML = data.keys.map(k => {
      let sc = k.account === 'Not activated' ? 'unused' : k.status;
      let sl = k.account === 'Not activated' ? 'Unused' : k.status;
      let dt = k.days_left !== null ? k.days_left + 'd' : '-';
      if (sc === 'expired') dt = '0d';
      if (sc === 'revoked') dt = '-';
      return `<tr><td><span class="key-mono" onclick="navigator.clipboard.writeText('${k.key}');showToast('Copied!')">${k.key}</span></td><td style="font-family:'JetBrains Mono',monospace;font-size:12px">${k.account}</td><td><span class="badge ${sc}">${sl}</span></td><td>${dt}</td><td style="color:var(--dim);font-size:12px">${k.note||'-'}</td><td><div class="action-btns"><button class="btn-sm" onclick="manageKey('reset','${k.key}')">Reset</button><button class="btn-sm" onclick="extendKey('${k.key}')">+30d</button><button class="btn-sm danger" onclick="manageKey('revoke','${k.key}')">Revoke</button><button class="btn-sm danger" onclick="manageKey('delete','${k.key}')">X</button></div></td></tr>`;
    }).join('');
  } catch (e) { showToast('Failed to load keys', true); }
}

function updateStats(keys) {
  document.getElementById('statTotal').textContent = keys.length;
  document.getElementById('statActive').textContent = keys.filter(k => k.status === 'active').length;
  document.getElementById('statExpired').textContent = keys.filter(k => k.status === 'expired').length;
  document.getElementById('statRevoked').textContent = keys.filter(k => k.status === 'revoked').length;
}

function showModal(title, message, onConfirm) {
  document.getElementById('modalTitle').textContent = title;
  document.getElementById('modalMessage').innerHTML = message;
  document.getElementById('modalConfirm').onclick = () => { closeModal(); onConfirm(); };
  document.getElementById('confirmModal').classList.add('show');
}

function closeModal() { document.getElementById('confirmModal').classList.remove('show'); }

async function manageKey(action, key) {
  const titles = { revoke: 'Revoke License', reset: 'Reset License', delete: 'Delete License' };
  const msgs = { revoke: `Revoke <span class="key-display">${key}</span>?`, reset: `Reset <span class="key-display">${key}</span>? Will unbind from account.`, delete: `Delete <span class="key-display">${key}</span> permanently?` };
  showModal(titles[action], msgs[action], async () => {
    try {
      const res = await fetch('/api/manage', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${TOKEN}` }, body: JSON.stringify({ action, key }) });
      const data = await res.json();
      showToast(data.message || 'Done!');
      loadKeys();
    } catch (e) { showToast('Action failed', true); }
  });
}

async function extendKey(key) {
  showModal('Extend License', `Add 30 days to <span class="key-display">${key}</span>?`, async () => {
    try {
      const res = await fetch('/api/manage', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${TOKEN}` }, body: JSON.stringify({ action: 'extend', key, expiry_days: 30 }) });
      const data = await res.json();
      showToast(data.message || 'Extended!');
      loadKeys();
    } catch (e) { showToast('Failed', true); }
  });
}
</script>
</body>
</html>
